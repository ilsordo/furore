---
title: 2013 OCaml Labs Review
author: Anil Madhavapeddy
rights:  Creative Commons Non-Commercial Share Alike 3.0
language: en-US
---

## 2013 in Review

[2013 review](graphics/ocl13rev/lab_main.jpg){.floater}
This time last year in 2012, I had just
[announced](http://anil.recoil.org/2012/10/19/announcing-ocaml-labs.html) the
formation of a new group called [OCaml Labs](http://www.cl.cam.ac.uk/projects/ocamllabs/) in the
[Cambridge Computer Lab](http://www.cl.cam.ac.uk) that would combine research
and community work towards the practical application of functional programming.
An incredible year has absolutely flown by, and I've put together this post to
summarise what's gone on, and point to our future directions for 2014.

The theme of our group was not to be pure research, but rather a hybrid group
that would take on some of the load of day-to-day OCaml maintenance from
[INRIA](http://caml.inria.fr), as well as help grow the wider OCaml community.
To this end, all of our projects have been highly collaborative, often
involving colleagues from [OCamlPro](http://ocamlpro.com),
[INRIA](http://gallium.inria.fr/), [Jane Street](http://janestreet.com),
[Lexifi](http://www.lexifi.com/) and [Citrix](http://citrix.com).

This post covers progress in [tooling](#tooling), the [compiler and
language](#core_compiler), [community efforts](#community_efforts), [research
projects](#research_projects) and concludes with our [priorities for
2014](#priorities_for_2014).

### Tooling

At the start of 2013, OCaml was in the interesting position of being a mature
decades-old language with a small, loyal community of industrial users who built
mission critical applications using it.  We had the opportunity to sit down
with many of them at the [OCaml Consortium](http://caml.inria.fr/consortium/)
meeting and prioritise where we started work.  The answer came back clearly:
while the compiler itself is legendary for its stability, the tooling around it
(such as package management) was a pressing problem.

#### OPAM

Our solution to this tooling was centered around the
[OPAM](http://opam.ocaml.org) package manager that
[OCamlPro](http://ocamlpro.com) released into beta just at the end of 2012, and
had its first stable release in March 2013.  OPAM differs from most system
package managers by emphasising a flexible distributed workflow that uses
version constraints to ensure incompatible libraries aren't mixed up (important
for the statically-typed OCaml that is very careful about dependencies).
Working closely with [OCamlPro](http://ocamlpro.com) we developed a git-based
workflow to make it possible for users (both individual or industrial) to
easily build up their own package repositories and redistribute OCaml code, and
started curating the [package
repository](https://github.com/ocaml/opam-repository).

The results have been satisfying: we started with an initial set of around 100
packages in
OPAM (mostly imported by the 4 developers), and ended 2013 with 587 unique packages and 2000 individual versions, with contributions from 160 individuals.  We now have a curated
[central package repository](https://github.com/ocaml/opam-repository) for anyone
to submit their OCaml code,
several third-party remotes are maintained (e.g. the [Xen Project](https://github.com/xapi-project/opam-repo-dev)
and [Ocsigen](https://github.com/ocsigen/opam-ocsigen)).  We also regularly
receive releases of the [Core](http://ocaml.janestreet.com) libraries
from Jane Street, and updates from sources as varied as [Facebook](https://github.com/ocaml/opam-repository/pull/1300),
[Coherent PDF](http://anil.recoil.org/2013/09/16/camlpdf-the-end-of-sucky-pdf-tools.html),
to the [Frenetic SDN](http://ocaml.org/meetings/ocaml/2013/slides/guha.pdf) research.

![Number of unique contributors to the central OPAM package repository](graphics/ocl13rev/opam11-contributors-dec13.png)

![Total number of unique packages (including multiple versions of the same package)](graphics/ocl13rev/opam11-packages-dec13.png)

![Total packages with multiple versions coalesced so you can see new package growth](graphics/ocl13rev/opam11-unique-packages-dec13.png)

A notable contribution from OCamlPro during this time was to
[clarify](https://github.com/ocaml/opam-repository/issues/955) the licensing on
the package repository to be the liberal
[CC0](http://creativecommons.org/choose/zero/), and also to pass ownership to
the [OCaml](http://github.com/ocaml) organization on GitHub, where it's now
jointly maintained by OCaml Labs, OCamlPro and anyone else that wishes to
contribute.

#### A lens into global OCaml code

It's been quite interesting just watching all the varied code fly into the
repository, but stability quickly became a concern as the new packages piled
up.  OCaml compiles to native code on not just x86, but also PowerPC, Sparc and
[ARM](http://anil.recoil.org/2012/02/25/dreamplug-debian-and-ocaml.html) CPUs.
We kicked off various efforts into automated testing: firstly [David Sheets](https://github.com/dsheets)
built the
[OCamlot](http://anil.recoil.org/2013/09/09/ocamlot-autotriaging.html) daemon
that would schedule builds across all the exotic hardware. Later in the year,
the [Travis](http://travis-ci.org) service launched support for testing from GitHub pull requests,
and this became the front line of [automated
checking](http://anil.recoil.org/2013/09/30/travis-and-ocaml.html) for all
incoming new packages to OPAM.

A major headache with automated testing is usually setting up the right build
environment with external library dependencies, and so we [added Docker
support](http://anil.recoil.org/2013/11/15/docker-and-opam.html) to make it
easier to bulk-build packages for local developer use, with the results of
builds available [publically](https://github.com/avsm/opam-bulk-logs) for
anyone to help triage.  Unfortunately fixing the bugs themselves is still a
[very manual process](https://github.com/ocaml/opam-repository/issues/1304), so
more volunteers are always welcome to help out!

![Travis CI](graphics/travis-mascot-200px.png){.floater}
We're going to be really seeing the rewards from all this effort as OCaml
4.02 development proceeds, since we can now adopt a data-driven approach
to changing language features instead of guessing how much third-party
code will break.  If your code is in OPAM, then it'll be tested as new
features such as [module aliases](http://caml.inria.fr/mantis/view.php?id=6063),
[injectivity](http://ocaml.org/meetings/ocaml/2013/slides/garrigue.pdf) and
[extension points](http://ocaml.org/meetings/ocaml/2013/slides/white.pdf) show up.

#### Better documentation

The venerable
[OCamlDoc](http://caml.inria.fr/pub/docs/manual-ocaml-4.00/manual029.html) tool
has done an admirable job for the last decade, but is increasingly showing its
age due to a lack of support for cross-referencing across packages.  We started
working on this problem in the summer when [Vincent Botbol](https://github.com/vincent-botbol)
visited us on an internship, expecting it to be a quick job to come up with
something as good as Haskell's excellent [Haddock](http://www.haskell.org/haddock/) online documentation.

Instead, we ran into the "module wall": since OCaml makes it so easy to
parameterise code over other modules, it makes it hard to generate static
documentation without outputting hundreds of megabytes of HTML every time.
After some hard work from Vincent and Leo, we've got a working prototype that
lets you simply run `opam install opam-doc && opam doc core async` to generate
package documentation.  You can see the results for
[Mirage](http://mirage.github.io/) online, but expect to see this integrated
into the main OCaml site for all OPAM packages as we work through polishing up
the user interface.

#### Turning OPAM into libraries

The other behind-the-scenes effort for OPAM has been to keep the core command-line
tool simple and stable, and to have it install OCaml libraries that can be
interfaced with by other tools to do domain-specific tasks.  [Thomas Gazagnaire](http://gazagnaire.org),
[Louis Gesbert](http://louis.gesbert.fr/cv.en.html) and [David Sheets](https://github.com/dsheets) have been steadily hacking away at this and
we now have [opamfu](https://github.com/ocamllabs/opamfu) to run operations
over all packages, and an easy-to-template [opam2web](https://github.com/ocaml/opam2web)
that generates the live [opam.ocaml.org](http://opam.ocaml.org) website.

This makes OPAM easier to deploy within other organizations that want to integrate
it into their workflow.  For example, the [software
section](http://www.cl.cam.ac.uk/projects/ocamllabs/pkg/) of the OCaml Labs website is regularly
generated from a search of all OPAM packages tagged `ocamllabs`.  We also used
it to rewrite the entire OPAM repository [in one epic diff](https://github.com/ocaml/opam-repository/pull/1240) to add external
library dependencies via a [command-line shim](https://github.com/ocaml/opam/pull/886/files).

#### OPAM-in-a-Box

All of this effort is geared towards making it easier to maintain reusable
local OPAM installations.  After several requests from big universities to help
out their teaching needs, we're putting together all the support needed to
easily redistribute OPAM packages via an
"[OPAM-in-a-Box](https://github.com/ocaml/opam/issues/1035)" command that uses
[Docker](http://docker.io) containers to let you clone and do lightweight
modifications of OCaml installations.

This will also be useful for anyone who'd like to run tutorials or teach OCaml,
without having to rely on flaky network connectivity at conference venues: a problem we've  [suffered from](http://amirchaudhry.com/fpdays-review) too!

### Core Compiler

[![Compiler Hacking](graphics/ocl13rev/compiler-hacking-thumb.jpg){.floater}](https://github.com/ocamllabs/compiler-hacking/wiki)

Starting to work on a real compiler can often be a daunting prospect, and so
one initiative we started this year is to host regular [compiler hacking sessions](http://ocamllabs.github.io/compiler-hacking/2013/10/30/third-compiler-hacking-session.html) where people could find a [curated list of features](https://github.com/ocamllabs/compiler-hacking/wiki) to work on, with the regular developers at hand to help out when people get stuck, and free beer and pizza to oil the coding wheels.  This has worked out well, with around 20 people showing up on average for the three we held, and [several patches](https://github.com/ocamllabs/compiler-hacking/wiki/Things-previously-worked-on) submitted upstream to OCaml.  [Gabriel Scherer](http://gallium.inria.fr/~scherer/) and [Damien Doligez](http://cristal.inria.fr/~doligez/) have been helping this effort by tagging [junior jobs](http://caml.inria.fr/mantis/search.php?project_id=1&sticky_issues=1&sortby=last_updated&dir=DESC&highlight_changed=24&hide_status_id=90&tag_string=junior_job) in the OCaml Mantis bug tracker as they are filed.

#### Syntax transformations and extension points

[Leo White](http://www.lpw25.net) started the year fresh out of completing his PhD with [Alan Mycroft](https://www.cl.cam.ac.uk/~am21/), and before he realized what he'd
gotten himself into was working with [Alain Frisch](http://alain.frisch.fr/) on the
future of syntax transformations in OCaml.  We started off our first
[wg-camlp4](http://lists.ocaml.org/listinfo/wg-camlp4) working group on the new
[lists.ocaml.org](http://lists.ocaml.org) host, and a spirited discussion
[started](http://lists.ocaml.org/pipermail/wg-camlp4/2013-January/thread.html) that
went [on](http://lists.ocaml.org/pipermail/wg-camlp4/2013-February/thread.html)
and [on](http://lists.ocaml.org/pipermail/wg-camlp4/2013-March/thread.html) for
several months.  It ended with a very satisfying design for a simpler *extension
points* mechanism which Leo [presented](http://ocaml.org/meetings/ocaml/2013/slides/white.pdf)
at the OCaml 2013 workshop at ICFP, and is now merged into OCaml 4.02-trunk.

#### Namespaces

Not all of the working groups were quite as successful in coming to a conclusion as the Camlp4 one.  On the Platform mailing list, Gabriel Scherer started a discussion on the design for [namespaces](http://lists.ocaml.org/pipermail/platform/2013-February/000050.html) in OCaml.  The resulting discussion was useful in separating multiple concerns that were intermingled in the initial proposal, and Leo wrote a [comprehensive blog post](http://www.lpw25.net/2013/03/10/ocaml-namespaces.html) on a proposed namespace design.

After further discussion at [ICFP 2013](http://icfpconference.org/icfp2013/) with Jacques Garrigue later in the year, it turns out adding support for [module aliases](http://caml.inria.fr/mantis/view.php?id=6063) would solve much of the cost associated with compiling large libraries such as [Core](http://ocaml.janestreet.com), with no backwards compatibility issues.  This solution has now been integrated into OCaml 4.02.0dev and is being tested with Core.

#### Delving into the bug tracker

Jeremy Yallop joined us in April, and he and Leo also leapt into the core
compiler and started triaging issues on the OCaml [bug
tracker](http://caml.inria.fr/mantis).  This seems unglamorous in the
beginning, but there rapidly turned out to be many fascinating threads that
shed light on OCaml's design and implementation through seemingly harmless
bugs.  Here is a pick of some interesting threads through the year that we've
been involved with:

* An [unexpected interaction between variance and GADTs](http://caml.inria.fr/mantis/view.php?id=5985&nbn=49#bugnotes)
  that led to Jacques Garrigue's [talk](http://ocaml.org/meetings/ocaml/2013/slides/garrigue.pdf) at OCaml 2013.
* Type unsoundness by [pattern matching lazy mutable values](http://caml.inria.fr/mantis/view.php?id=5992), thus
  shedding light on the precise semantics of the order of pattern matching.
* Leo proposed an [open types](http://caml.inria.fr/mantis/view.php?id=5584) extension
  to allow abstract types to be declared open. You can try it via `opam switch 4.00.1+open-types`.
* Designing the popular, but controversial [record disambiguation feature](http://caml.inria.fr/mantis/view.php?id=5759) in OCaml 4.01.0, and debating [the right warnings](http://caml.inria.fr/mantis/view.php?id=6000) needed to prevent programmer surprise.
* Exposing a [GADT representation for Bigarray](http://caml.inria.fr/mantis/view.php?id=6064).

This is just a sample of some of the issues solved in Mantis; if you want to
learn more about OCaml, it's well worth browsing through it to learn from over
a decade of interesting discussions from all the developers.

#### Thread-local storage runtime

While OCamlPro was working on their [reentrant OCaml runtime](https://github.com/lucasaiu/ocaml), we took a different tack by adding [thread-local storage](https://github.com/ocamllabs/ocaml/tree/multicore) to the runtime instead, courtesy of [Stephen Dolan](http://mu.netsoc.ie/).  This is an important choice to make at the outset of adding multicore, so both approaches are warranted.  The preemptive runtime adds a lot of code churn (due to adding a context parameter to most function calls) and takes up a register, whereas the thread-local storage approach we tried doesn't permit callbacks to different threads.

Much of this work isn't interesting on its own, but forms the basis for a fully multicore runtime (with associated programming model) in 2014. Stay tuned!

#### Ctypes

![graphics/ocl13rev/c.png]{.floater}
One other complaint from the Consortium members was quite surprising: the difficulty of using the OCaml foreign function interface safely to interface with C code.  Jeremy Yallop began working on the [ctypes](https://github.com/ocamllabs/ocaml-ctypes) library that had the goal of eliminating the need to write any C code at all for the vast majority of foreign bindings.

Instead, Ctypes lets you describe any C function call as an OCaml value, and provides various linkage options to invoke that function into C.  The first option he implemented was a `dlopen` interface, which immediately brought us the same level of functionality as the [Python](http://docs.python.org/2/library/ctypes.html) or [Haskell](http://www.haskell.org/haskellwiki/Library/libffi) Ctypes equivalents.  This early code was in itself startlingly useful and more pleasant to use than the raw FFI, and various folk (such as David Sheets' [libsodium](https://github.com/dsheets/ocaml-sodium) cryptography bindings) started adopting it.

At this point, I happened to be struggling to write the Foreign Function Interface chapter of [Real World OCaml](https://realworldocaml.org) without blowing through our page budget with a comprehensive explanation of the existing system.  I decided to take a risk and write about Ctypes instead, since it let new users to the language have a *far* more productive experience to get started.  Xavier Leroy pointed out [some shortcomings](https://github.com/realworldocaml/book/issues/1701) of the library in his technical book review, most notably with the lack of an interface with C macros.  The design of Ctypes fully supports alternate linking mechanisms than just `dlopen` though, and Jeremy has added automatic C stub generation support as well.  This means that if you use Ctypes to build an OCaml binding in 2014, you can choose several mechanisms for the same source code to link to the external system.  Jeremy even demonstrated a forking model at OCaml 2013 that protects the OCaml runtime from the C binding via process separation.

The effort is paying off: Daniel Bünzli [ported SDL2](http://alan.petitepomme.net/cwn/2013.12.17.html#9) using ctypes, and gave us extensive [feedback](https://github.com/ocamllabs/ocaml-ctypes/issues) about any missing corner cases, and the resulting bindings don't require any C code to be written.  [Jonathan Protzenko](http://xulforum.org) even used it to implement an OCaml controller for the [Adafruit Raspberry Pi RGB LCD](http://gallium.inria.fr/blog/raspi-lcd/)!

### Community Efforts

Our community efforts were largely online, but we also hosted visitors over the year and regular face-to-face tutorials.

#### Online at OCaml.org

![OCaml.org](graphics/ocl13rev/ocaml-org-thumb.png){.floater}
While the rest of the crew were hacking on OPAM and OCaml, [Amir Chaudhry](http://amirchaudhry.com/) and [Philippe Wang](http://philippewang.info/CL/) teamed up with Ashish Agarwal and Christophe Troestler to redesign and relaunch the [OCaml website](http://ocaml.org).  Historically, OCaml's homepage has been the [caml.inria.fr](http://caml.inria.fr) domain, and the [ocaml.org](http://ocaml.org) effort was begun by Christophe and Ashish [some years ago](https://www.mail-archive.com/caml-list@inria.fr/msg00169.html) to modernize the web presence.

The webpages were already rather large with complex scripting (for example, the [99 Problems](http://ocaml.org/learn/tutorials/99problems.html) page runs the OCaml code to autogenerate the output). Philippe developed a [template DSL](https://github.com/pw374/MPP-language-blender) that made it easier to unify a lot of the templates around the website, and also a [Markdown parser](https://github.com/pw374/omd) that we could link to as a library from the rest of the infrastructure without shelling out to Pandoc.

Meanwhile, Amir designed a series of [interactive wireframe sketches](http://amirchaudhry.com/wireframe-demos-for-ocamlorg/)  and [gathered feedback]((http://amirchaudhry.com/ocamlorg-request-for-feedback/) on it from the community. A local [design agency](http://onespacemedia.com) in Cambridge helped with visual look and feel, and finally at the end of the summer we began the [migration](http://amirchaudhry.com/migration-plan-ocaml-org/) to the new website, followed by a triumphant [switchover](http://amirchaudhry.com/announcing-new-ocamlorg/) in November to the design you see today.

The domain isn't just limited to the website itself.  Leo and I set up a [SVN-to-Git mirror](https://github.com/ocaml/ocaml.org-scripts) of the OCaml compiler [Subversion repository](http://caml.inria.fr/ocaml/anonsvn.en.html) on the GitHub [OCaml organization](https://github.com/ocaml/ocaml), which is proving popular with developers.  There is an ongoing effort to simplify the core compiler tree by splitting out some of the larger components, and so [camlp4](http://github.com/ocaml/camlp4) is also now hosted on that organization, along with [OASIS](https://github.com/ocaml/oasis).  We also administer several subdomains of [ocaml.org](http://ocaml.org), such as the [mailing lists](http://lists.ocaml.org) and the [OPAM repository](http://opam.ocaml.org), and other services such as the [OCaml Forge](http://forge.ocamlcore.org) are currently migrating over.  This was made significantly easier thanks to sponsorship from [Rackspace Cloud](http://rackspace.com) (users of [XenServer](http://xenserver.org) which is written in OCaml). They saw our struggles with managing physical machines and gave us developer accounts, and all of the ocaml.org infrastructure is now hosted on Rackspace.  We're very grateful to their ongoing help!

![Rackspace](graphics/ocl13rev/rackspace.png){.floater}
If you'd like to contribute to infrastructure help  (for example, I'm experimenting with a [GitLab](http://git.ocaml.org/public/) mirror), then please join the [infrastructure@lists.ocaml.org](http://lists.ocaml.org/listinfo/infrastructure) mailing list and share your thoughts.  The website team also need help with adding content and [international translations](https://github.com/ocaml/ocaml.org/issues/376), so head over to the [website issue tracker](http://github.com/ocaml/ocaml.org/issues) and start proposing improvements you'd like to see.

#### Next steps for ocaml.org

The floodgates requesting features opened up after the launch of the new look and feel.  Pretty much everyone wanted deeper OPAM integration into the main website, for features such as:

* Starring and reviewing packages
* Integrating the [opam-doc](https://github.com/ocamllabs/opam-doc) documentation with the metadata
* Display test results and a compatibility matrix for non-x86 and non-Linux architectures.
* Link to blog posts and tutorials about the package.

Many of these features were part of the [original wireframes](http://amirchaudhry.com/wireframe-demos-for-ocamlorg/) but we're being careful to take a long-term view of how they should be created and maintained.
Rather than building all of this as a huge bloated [opam2web](https://github.com/ocaml/opam2web) extension, David Sheets (our resident relucant-to-admit-it web expert) has designed an overlay directory scheme that permits the overlaying of different metadata onto the website. This lets one particular feature (such as blog post aggregation) be handled separately from the others via Atom aggregators.

#### Real World OCaml

![Real World OCaml](graphics/ocl13rev/rwo.png){.floater}
A big effort that took up most of the year for me was finishing and publishing an O'Reilly book called [Real World OCaml](https://realworldocaml.org) with [Yaron Minsky](https://ocaml.janestreet.com/?q=blog/5) and Jason Hickey.  Yaron describes how it all started in [his blog post](https://ocaml.janestreet.com/?q=node/117), but I learnt a lot from developing a book using the [open commenting scheme](http://anil.recoil.org/2013/06/17/real-world-ocaml-beta-available.html) that we
developed just for this.

In particular, the book ended up shining a bright light into dark language corners that we might otherwise not have explored in OCaml Labs.  Two chapters of the book that I wasn't satisfied with were the [objects](https://realworldocaml.org/v1/en/html/objects.html) and [classes](https://realworldocaml.org/v1/en/html/classes.html) chapters, largely since neither Yaron nor Jason nor I had ever really used their full power in our own code.  Luckily, Leo White decided to pick up the baton and champion these oft-maligned (but very powerful) features of OCaml, and the result is the clearest explanation of them that I've read yet.  Meanwhile, Jeremy Yallop helped out with extensive review of the [Foreign Function Interface](https://realworldocaml.org/v1/en/html/foreign-function-interface.html) chapter that used his [ctypes](https://github.com/ocamllabs/ocaml-ctypes) library.  Finally, [Jeremie Diminio](https://plus.google.com/100586365409172579442/posts) at Jane Street worked hard on adding several features to his [utop](https://github.com/diml/utop) toplevel that made it compelling enough to become our default recommendation for newcomers.

All in all, we ended up closing over [2000 comments](http://anil.recoil.org/2013/08/06/real-world-ocaml-beta2.html) in the process of writing the book, and I'm very proud of the result (freely available [online](https://realworldocaml.org), but do [buy a copy](http://www.amazon.com/Real-World-OCaml-Functional-programming/dp/144932391X/) if you can to support it).  Still, there's more I'd like to do in 2014 to improve the ease of using OCaml further.  In particular, I removed a chapter on packaging and build systems since I wasn't happy with its quality, and both [Thomas Gazagnaire](http://gazagnaire.org) and I intend to spend time in 2014 on improving this part of the ecosystem.

#### Tutorials and Talks

We had a lively presence at [ICFP 2013](http://icfpconference.org) this year, with the third iteration of the [OCaml 2013](http://ocaml.org/meetings/ocaml/2013/program.html) held there, and Stephen Dolan presenting a paper in the main conference.  I [liveblogged OCaml 2013](http://www.syslog.cl.cam.ac.uk/2013/09/24/liveblogging-ocaml-workshop-2013/) and [CUFP 2013](http://www.syslog.cl.cam.ac.uk/2013/09/22/liveblogging-cufp-2013/) as they happened, and all the [talks](http://ocaml.org/meetings/ocaml/2013/program.html) we gave are linked from the program.  The most exciting part of the conference for a lot of us were the two talks by Facebook on their use of OCaml: first for [program analysis using Pfff](http://ocaml.org/meetings/ocaml/2013/slides/padioleau.pdf) and then to migrate their massive PHP codebase [using an OCaml compiler](http://www.youtube.com/watch?feature=player_detailpage&v=gKWNjFagR9k#t=1150).  I also had the  opportunity to participate in a panel at the Haskell Workshop on whether [Haskell is too big to fail yet](http://ezyang.tumblr.com/post/62157468762/haskell-haskell-and-ghc-too-big-to-fail-panel); lots of interesting perspectives on scaling another formerly academic language into the real world.

[Yaron Minsky](https://ocaml.janestreet.com/?q=blog/5) and I have been giving tutorials on OCaml at ICFP for several years, but the release of Real World OCaml has made it significantly easier to give tutorials without the sort of labor intensity that it took in previous years (one memorable ICFP 2011 tutorial that we did took almost 2 hours to get everyone installed with OCaml.  In ICFP 2013, it took us 15 minutes or so to get everyone started).  Still, giving tutorials at ICFP is very much preaching to the choir, and so we've started speaking at more general-purpose events.

![Julien Verlaguet and Yoann Padioleau show off Pfff code visualisation at Facebook](graphics/ocl13rev/pfff.jpg)

![Marius Eriksen and Yaron Minsky start a Scala vs OCaml rap battle at the ICFP industrial fair. Maybe.](graphics/ocl13rev/marius-yaron-icfp.jpg)

![>A successful FPDays tutorial in Cambridge, with all attendees getting a free copy of Real World OCaml](graphics/ocl13rev/fpdays2013-04.jpg)

Our first local effort was [FPDays](http://fpdays.net/2013/) in Cambridge, where Jeremy Yallop and Amir Chaudhry ran the tutorial with help from Phillipe Wang, Leo White and David Sheets. The OCaml session there ended up being the biggest one in the entire two days, and Amir [wrote up](http://amirchaudhry.com/fpdays-review/) their experiences.  One interesting change from our ICFP tutorial is that Jeremy used [js_of_ocaml](https://github.com/ocsigen/js_of_ocaml) to teach OCaml via JavaScript by building a fun [Monty Hall](https://github.com/ocamllabs/fpdays-skeleton) game.

#### Visitors and Interns


![Visitors](graphics/ocl13rev/thomas-nycoug-2013.jpg)
Since OCaml Labs is a normal group within the [Cambridge Computer Lab](http://www.cl.cam.ac.uk), we often host academic visitors and interns who pass through.  This year was certainly diverse, and we welcomed a range of colleagues:

* [Mathias Bourgoin](http://www.lip6.fr/actualite/personnes-fiche.php?ident=D1161&LANG=en) has just finished his work on interfacing OCaml with GPUs, and gave us a seminar on how his [SPOC](http://www.algo-prog.info/spoc/web/index.php?id=spoc) tool works (also available in OPAM via a [custom remote](http://www.algo-prog.info/spoc/distribution/opam/)).
* [Benjamin Canou](http://www.benjamin.canou.fr/) (now at OCamlPro) practised his [OCaml 2013 talk](http://ocaml.org/meetings/ocaml/2013/slides/canou.pdf) on building high-level interfaces to JavaScript with OCaml by giving a departmental seminar.
* [Roberto Di Cosmo](http://www.dicosmo.org/), who directs the [IRILL](http://www.irill.org/) organization on Free Software in Paris delivered a seminar on constraint solving for [package systems](http://mancoosi.org) that are as large-scale as Debian's.
* [Thomas Gazagnaire](http://gazagnaire.org) visited during the summer to help plot the [Mirage 1.0](http://openmirage.org/blog/mirage-1.0.3-released) and [OPAM 1.1](http://anil.recoil.org/2013/09/20/opam-1-1-beta.html) releases.  He has also since joined OCaml Labs fulltime to work on [Nymote](http://nymote.org).
* [Louis Gesbert](http://louis.gesbert.fr/cv.en.html) from OCamlPro visited for 2 weeks in December and kicked off the inaugral OPAM developers summit (which was, admittedly, just 5 developers in the [Kingston Arms](http://www.kingston-arms.co.uk/), but all good things start in a pub, right?)
* [Jonathan Protzenko](http://www.xulforum.org/) presented his PhD work on [Mezzo](http://protz.github.io/mezzo/) (which is now [merged into OPAM](http://gallium.inria.fr/blog/mezzo-on-opam/)), and educated us on the vagaries of [Windows support](http://protz.github.io/ocaml-installer/).
* [Gabriel Scherer](http://gallium.inria.fr/~scherer/) from the Gallium INRIA group visited to discuss the direction of OPAM and various language feature discussions (such as namespaces).  He didn't give a talk, but promises to do so next time!
* [Benoît Vaugon](https://github.com/bvaugon) gave a seminar on his [OCamlCC](http://oud.ocaml.org/2012/slides/oud2012-paper10-slides.pdf) OCaml-to-C compiler, talked about porting OCaml to [8-bit PICs](http://www.algo-prog.info/ocaml_for_pic/web/index.php?id=ocapic), and using GADTs to [implement Printf](http://caml.inria.fr/mantis/view.php?id=6017) properly.

We were also visited several times by [Wojciech Meyer](http://danmey.org/) from ARM, who was an OCaml developer who maintained (among other things) the [ocamlbuild](http://brion.inria.fr/gallium/index.php/Ocamlbuild) system and worked on [DragonKit](http://www.youtube.com/watch?v=d9Hg5L76FG8) (an extensible LLVM-like compiler written in OCaml).  Wojciech very sadly passed away on November 18th, and we all fondly remember his enthusiastic and intelligent contributions to our small Cambridge community.

We also hosted visitors to live in Cambridge and work with us over the summer.  In addition to Vincent Botbol (who worked on OPAM-doc as described earlier) we had the pleasure of having [Daniel Bünzli](http://erratique.ch/) and [Xavier Clerc](http://www.x9c.fr/) work here.  Here's what they did in their own words.

##### Xavier Clerc: OCamlJava

Xavier Clerc took a break from his regular duties at INRIA to join us over the summer
to work on [OCaml-Java](http://ocamljava.x9c.fr/preview/) and adapt it to the latest
JVM features.  This is an incredibly important project to bridge OCaml with the huge
Java community, and here's his report:

> After a four-month visit to the OCaml Labs dedicated to the [OCaml-Java](http://ocamljava.x9c.fr/preview/)
> project, the time has come for an appraisal! The undertaken work can be split
> into two areas: improvements to code generation, and interaction between the
> OCaml & Java languages.  Regarding code generation, several classical
> optimizations have been added to the compiler, for example loop unrolling,
> more aggressive unboxing, better handling of globals, or partial evaluation
> (at the bytecode level). A new tool, namely ocamljar, has been introduced
> allowing post-compilation optimizations. The underlying idea is that some
> optimizations cannot always be applied (e.g. depending whether multiple
> threads/programs will coexist), but enabling them through command-line flags
> would lead to recompilation and/or multiple installations of each library
> according to the set of chosen optimizations. It is thus far more easier to
> first build an executable jar file, and then modify it according to these
> optimizations. Furthermore, this workflow allows the ocamljar tool to take
> advantage of whole-program information for some optimizations.  All these
> improvements, combined, often lead to a gain of roughly 1/3 in terms of
> execution time.
>
> Regarding language interoperability, there are actually two directions 
> depending on whether you want to call OCaml code from Java, or want to call 
> Java code from OCaml. For the first direction, a tool allows to generate Java
> source files from OCaml compiled interfaces, mapping the various constructs
> of the OCaml language to Java classes. It is then possible to call functions, 
> and to manipulate instances of OCaml types in pure Java, still benefiting 
> from the type safety provided by the OCaml language. In the other direction,
> an extension of the OCaml typer is provided allowing to create and manipulate
> Java instances directly from OCaml sources. This typer extension is indeed a
> thin layer upon the original OCaml typer, that is mainly responsible for
> encoding Java types into OCaml types.  This encoding uses a number of
> advanced elements such as polymorphic variants, subtyping, variance
> annotations, phantom typing, and printf-hack, but the end-user does not have
> to be aware of this encoding. On the surface, the type of instances of the
> Java Object classes is `java'lang'Object java_instance`, and instances can be
> created by calling Java.make `Object()`.
>
> While still under heavy development, a working prototype [is available](http://ocamljava.x9c.fr/preview/), and bugs [can be reported](http://bugs.x9c.fr/). Finally, I would like to thank the OCaml Labs for providing a great working
> environment.

##### Daniel Bünzli: Typography and Visualisation

![Bunzli](graphics/ocl13rev/daniel-presentation-vg.jpg)
Daniel joined us from Switzerland, and spent some time at Citrix before joining us in OCaml Labs.  All of his [software](http://erratique.ch/software) is now on OPAM, and is seeing ever-increasing adoption from the community.

> Released a first version of [Vg](http://erratique.ch/software/vg) [...] I'm
> especially happy about that as I wanted to use and work on these ideas since
> at least 2008. The project is a long term project and is certainly not
> finished yet but this is already a huge step.
>
> Adjusted and released a first version of
> [Gg](http://erratique.ch/software/gg). While the module was already mostly
> written before my arrival to Cambridge, the development of Vg and Vz prompted
> me to make some changes to the module.
>
> [...] released [Otfm](http://erratique.ch/software/otfm), a
> module to decode OpenType fonts. This is a work in progress as not every
> OpenType table has built-in support for decoding yet. But since it is needed
> by Vg's PDF renderer I had to cut a release. It can however already be used
> to implement certain simple things like font kerning with Vg, this can be
> seen in action in the `vecho` binary installed by Vg.
>
> Started to work on [Vz](http://erratique.ch/software/vz/doc/Vz.html), a
> module for helping to map data to Vg images. This is really unfinished and is
> still considered to be at a design stage. There are a few things that are
> however well implemented like (human) perceptually meaningful [color
> palettes](http://erratique.ch/software/vz/demos/color_schemes.html) and the
> small folding stat module (`Vz.Stat`). However it quickly became evident that
> I needed to have more in the box w.r.t. text rendering in Vg/Otfm. Things
> like d3js entirely rely on the SVG/CSS support for text which makes it easy
> to e.g. align things (like tick labels on [such
> drawings](http://erratique.ch/software/vz/demos/iris.html)). If you can't
> rely on that you need ways of measuring rendered text. So I decided to
> suspend the work on Vz and put more energy in making a first good release of
> Vg. Vz still needs quite some design work, especially since it tries to be
> independent of Vg's backend and from the mechanism for user input.
>
> Spent some time figuring out a new "opam-friendly" release workflow in 
> pkgopkg. One of my problem is that by designing in the small for programming
> in the large --- what a slogan --- the number of packages I'm publishing is
> growing (12 and still counting). This means that I need to scale horizontally
> maintenance-wise unhelped by the sad state of build systems for OCaml. I need
> tools that make the release process flawless, painless and up to my quality
> standards. This lead me to enhance and consolidate my old scattered
> distribution scripts in that repo, killing my dependencies on Oasis and
> ocamlfind along the way. *(edited for brevity, see [here](https://github.com/dbuenzli/pkgopkg))*

Daniel also left his bicycle here for future visitors to use, and the "Bünzli-bike"
is available for our next visitor! (Louis Gesbert even donated lights, giving
it a semblance of safety).

#### Industrial Fellows

Most of our regular funding bodies such as [EPSRC](http://epsrc.ac.uk) or [EU FP7](http://cordis.europa.eu/fp7/home_en.html) provide funding, but leave all the intellectual input to the academics.  A compelling aspect of OCaml Labs has been how involved our industrial colleagues have been with the day-to-day problems that we solve.  Both Jane Street and Citrix have senior staff regularly visiting our group and working alongside us as industrial fellows in the Computer Lab.

* ![Jane Street](graphics/ocl13rev/js.jpg)
[Mark Shinwell](http://www.three-tuns.net/mark/) from Jane Street Europe has been working on improving the [state of native debugging](http://www.youtube.com/watch?v=NF2WpWnB-nk) in OCaml, by adding extended DWARF debugging information to the compiler output.  Mark is also a useful source of feedback about the forthcoming design of multicore, since he has daily insight into a huge production codebase at Jane Street (and can tell us about it without us requiring access!).

* ![XenServer](graphics/ocl13rev/xenserver.png)
[Dave Scott](http://dave.recoil.org) is the principal architect of [XenServer](http://xenserver.org) at Citrix in Cambridge.  This year has been transformative for that project, since Citrix [open-sourced XenServer](http://blogs.citrix.com/2013/06/26/open-source-what-does-it-mean-for-xenserver/) to GitHub and fully adopted OPAM into their workflow.  Dave is the author of numerous libraries that have all been released to OPAM, and his colleagues [Jon Ludlam](http://jon.recoil.org) and [Euan Harris](http://www.xenserver.org/blog/blogger/listings/euanh.html) are also regular visitors who have also been contributors to the OPAM and Mirage ecosystems.
 
### Research Projects

The other 100% of our time at the Labs is spent on research projects.  When we started the group, I wanted to set up a feedback loop between local people *using* OCaml to build systems, with the folk *developing* OCaml itself.  This has worked out particularly well with a couple of big research projects in the Lab.

#### Mirage

Mirage is a [library operating system](http://anil.recoil.org/papers/2013-asplos-mirage.pdf) written in OCaml that compiles source code into specialised Xen microkernels, developed at the Cambridge Computer Lab, Citrix and the [Horizon Digital Economy](http://horizon.ac.uk) institute at Nottingham.  This year saw several years of effort culminate in the first release of [Mirage 1.0](http://openmirage.org) as a self-hosting entity.  While Mirage started off as a [quick experiment](http://anil.recoil.org/papers/2010-hotcloud-lamp.pdf) into building specialised virtual appliances, it rapidly became useful to make into a real system for use in bigger research projects.  You can learn more about Mirage [here](http://openmirage.org/docs), or read the [Communications of the ACM](http://cacm.acm.org/magazines/2014/1/170866-unikernels/abstract) article that [Dave Scott](http://dave.recoil.org) and I wrote to close out the year.

![MirageOS](graphics/ocl13rev/mirageos.png)
This project is where the OCaml Labs "feedback loop" has been strongest.  A typical [Mirage application](http://www.openmirage.org/wiki/hello-world) consists of around 50 libraries that are all installed via OPAM.  These range from [device drivers](https://github.com/mirage/mirage-block-xen) to protocol libraries for [HTTP](https://github.com/avsm/ocaml-cohttp) or [DNS](https://github.com/mirage/ocaml-dns), to filesystems such as [FAT32](https://github.com/mirage/ocaml-fat).  Coordinating [regular releases](http://openmirage.org/blog/mirage-1.0.3-released) of all of these would be near impossible without using OPAM, and has also forced us to use our own tools daily, helping to sort out bugs more quickly.  You can see the full list of libraries on the [OCaml Labs software page](http://www.cl.cam.ac.uk/projects/ocamllabs/pkg/).

Mirage is also starting to share code with big projects such as [XenServer](http://xenserver.org) now, and we have been working with Citrix engineers to help them to move to the [Core](http://ocaml.janestreet.com) library that Jane Street has released (and that is covered in [Real World OCaml](https://realworldocaml.org)).  Moving production codebases this large can take years, but OCaml Labs is turning out to be a good place to start unifying some of the bigger users of OCaml into one place.  We're also now an official [Xen Project incubator project](http://www.xenproject.org/developers/teams/mirage-os.html), which helps us to validate functional programming  to other Linux Foundation efforts.

#### Nymote and User Centric Networking

![Nymote](graphics/ocl13rev/nymote.png)
The release of Mirage 1.0 has put us on the road to simplifying embedded systems programming. The move to the centralized cloud has led to regular well-publicised privacy and security threats to the way [we handle](http://de2013.org/wp-content/uploads/2013/09/de2013_submission_25-1.pdf) our digital infrastructure, and so [Jon Crowcroft](http://www.cl.cam.ac.uk/~jac22/), [Richard Mortier](http://www.cs.nott.ac.uk/~rmm/) and I are leading an effort to build an alternative privacy-preserving infrastructure using embedded devices as part of the [User Centric Networking](http://usercentricnetworking.eu/) project, in collaboration with a host of companies led by [Technicolor](http://www.thlab.net/) Paris.
This work also plays on the strong points of OCaml: it already has a [fast ARM backend](http://anil.recoil.org/2012/02/25/dreamplug-debian-and-ocaml.html), and Mirage can easily be ported to the new Xen/ARM target as hardware becomes available.

One of the most difficult aspects of programming on the "wide area" Internet are dealing with the lack of a distributed identity service that's fully secure.  We published [our thoughts](http://anil.recoil.org/papers/2013-foci-signposts.pdf) on this at the USENIX Free and Open Communications on the Internet workhsop, and David Sheets is working towards a full implementation using Mirage.  If you're interested in following this effort, Amir Chaudhry is blogging at the [Nymote](http://nymote.org/) project website, where we'll talk about the components as they are released.

#### Data Center Networking

At the other extreme from embedded programming is datacenter networking, and we started the [Network-as-a-Service](http://gow.epsrc.ac.uk/NGBOViewGrant.aspx?GrantRef=EP/K034723/1) research project with [Imperial College](http://gow.epsrc.ac.uk/NGBOViewGrant.aspx?GrantRef=EP/K032968/1) and [Nottingham](http://gow.epsrc.ac.uk/NGBOViewGrant.aspx?GrantRef=EP/K031724/1).  With the rapid rise of [Software Defined Networking](http://en.wikipedia.org/wiki/Software-defined_networking) this year, we are investigating how application-specific customisation of network resources can build fast, better, cheaper infrasructure.  OCaml is in a good position here: several other groups have built OpenFlow controllers in OCaml (most notably, the [Frenetic Project](https://github.com/frenetic-lang)), and Mirage is specifically designed to assemble such bespoke infrastructure.

Another aspect we've been considering is how to solve the problem of optimal connectivity across nodes.  TCP is increasingly considered harmful in high-through, high-density clusters, and [George Parisis](http://www.sussex.ac.uk/informatics/people/peoplelists/person/334868) led the design of [Trevi](http://anil.recoil.org/papers/2013-hotnets-trevi.pdf), which is a fountain-coding based alternative for storage networking.  Meanwhile, [Thomas Gazagnaire](http://gazagnaire.org) (who joined OCaml Labs in November), has been working on a branch-consistent data store called [Irminsule](https://github.com/samoht/irminsule) which supports scalable data sharing and reconciliation using Mirage.  Both of these systems will see implementations based on the research done this year.

#### Higher Kinded Programming

Jeremy Yallop and Leo White have been developing an approach that makes it possible to write programs with higher-kinded polymorphism (such as monadic functions that are polymorphic in the monad they use) without using functors. It's early days yet, but there's a [library](https://github.com/ocamllabs/higher) available on [OPAM](http://opam.ocaml.org/pkg/higher/higher.0.1) that implements the approach, and a [draft
paper](https://github.com/ocamllabs/higher/raw/paper/higher.pdf) that outlines the design.

### Priorities for 2014

This year has been a wild ride to get us up to speed, but we now have a solid sense of what to work on for 2014.  We've decided on a high-level set of priorities led by the senior members of the group:

* **Multicore**: Leo White will be leading efforts in putting an end-to-end multicore capable OCaml together.
* **Metaprogramming**: Jeremy Yallop will direct the metaprogramming efforts, continuing with Ctypes and into macros and extension points.
* **Platform**: Thomas Gazagnaire will continue to drive OPAM development towards becoming the first [OCaml Platform](http://ocaml.org/meetings/ocaml/2013/slides/madhavapeddy.pdf).
* **Online**: Amir Chaudhry will develop the online and community efforts that started in 2013.

These are guidelines to choosing where to spend our time, but not excluding other work or day-to-day bugfixing. Our focus on collaboration with Jane Street, Citrix, Lexifi, OCamlPro and our existing colleagues will continue, as well as warmly welcoming new community members that wish to work with us on any of the projects, either via internships, studentships or good old-fashioned open source hacking.

I appreciate the [whole team's](http://www.cl.cam.ac.uk/projects/ocamllabs/people/) feedback in editing this long post into shape, the amazing professorial support from [Jon Crowcroft](http://www.cl.cam.ac.uk/~jac22/), [Ian Leslie](https://www.cl.cam.ac.uk/~iml1/) and [Alan Mycroft](https://www.cl.cam.ac.uk/~am21/) throughout the year, and of course the funding and support from Jane Street, Citrix, RCUK, EPSRC, DARPA and the EU FP7 that made all this possible.  Roll on 2014, and please do [get in touch](mailto:avsm2@cl.cam.ac.uk) with me with any queries!
